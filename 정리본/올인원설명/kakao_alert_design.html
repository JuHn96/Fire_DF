<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>카카오 알림 로직 & 템플릿 설계</title>
  <style>
    /* 2-C 공통 스타일 시작 */

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      line-height: 1.7;
      margin: 0;
      padding: 32px 16px;
      color: #1f2937;
      background-color: #e5e7eb;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 16px;
      padding: 28px 32px 32px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      border: 1px solid #e5e7eb;
    }

    h1, h2, h3 {
      margin-top: 0;
      color: #111827;
    }

    h1 {
      font-size: 30px;
      font-weight: 800;
      margin: 0 0 14px 0;
      letter-spacing: -0.03em;
      line-height: 1.3;
    }

    h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    h3 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 14px;
      margin-bottom: 8px;
    }

    .page-header {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 12px;
      margin-bottom: 20px;
    }

    .tagline {
      font-size: 15px;
      color: #4b5563;
      margin: 0;
    }

    .section {
      position: relative;
      background: linear-gradient(to right, #ffffff, #fafafa);
      padding: 16px 20px 16px 28px;
      border-radius: 12px;
      margin-bottom: 22px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
    }

    .section::before {
      content: "";
      position: absolute;
      left: 10px;
      top: 16px;
      bottom: 16px;
      width: 4px;
      border-radius: 999px;
      background: linear-gradient(to bottom, #ede9fe, #c4b5fd, #818cf8);
    }

    ul {
      margin-top: 6px;
      margin-bottom: 6px;
      padding-left: 20px;
    }

    li {
      margin-bottom: 6px;
      font-size: 14px;
    }

    .summary-box {
      margin-top: 10px;
      padding: 14px 16px;
      border-radius: 10px;
      border-left: 5px solid #818cf8;
      background: linear-gradient(to right, #eef2ff, #f5f3ff);
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
      font-size: 15px;
    }

    pre {
      background: #020617;
      color: #e5e7eb;
      padding: 14px;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 12px;
      margin-bottom: 12px;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      border: 1px solid #111827;
    }

    code {
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      background-color: #f3f4ff;
      padding: 2px 5px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      margin-bottom: 18px;
    }

    table th, table td {
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-size: 14px;
    }

    table th {
      background: #f3f4f6;
      font-weight: 600;
    }

    @media (max-width: 640px) {
      .page {
        padding: 20px 16px 22px;
        border-radius: 12px;
      }
      h1 { font-size: 24px; }
      h2 { font-size: 19px; }
    }

    /* 2-C 공통 스타일 끝 */
  </style>
</head>

<body>
  <div class="page">
    <header class="page-header">
      <h1>카카오 알림 로직 & 템플릿 설계</h1>
    </header>

    <div class="section">
      <h2>카카오 알림의 역할과 기본 개념</h2>
      <p>
        이 시스템에서 카카오 알림은:
      </p>
      <ul>
        <li><strong>위험 단계의 이벤트 발생 시</strong></li>
        <li><strong>관제실 밖에 있는 담당자(관리자/담당자 휴대폰)</strong>에게</li>
        <li><strong>짧고 핵심적인 정보만 푸시</strong>하는 용도입니다.</li>
      </ul>
      <p>
        관제 화면(웹)은 상세 모니터링,<br />
        카카오 알림은 “지금 급한 일이 생겼음”을 알려주는 <strong>외부 알림 채널</strong>이라고 보면 됩니다.
      </p>
    </div>

    <div class="section">
      <h2>알림 발생 조건(트리거 규칙)</h2>

      <h3>기본 조건</h3>
      <ul>
        <li>이벤트 레벨 기준:
          <ul>
            <li><code>WARNING</code> 이상 → 알림 후보</li>
            <li><code>DANGER</code> 이상 → 반드시 알림 발송</li>
          </ul>
        </li>
        <li>카메라/그룹별로 알림 ON/OFF 설정 가능하게 여유를 남김(옵션)</li>
      </ul>

      <h3>중복 방지 / 쿨타임</h3>
      <p>
        같은 카메라에서 몇 초 간격으로 불이 튈 수 있으니,
        아래와 같은 <strong>쿨타임 로직</strong>을 두면 좋습니다.
      </p>
      <ul>
        <li>같은 <code>camera_id</code> + 같은 <code>level</code> 에 대해:
          <ul>
            <li>최근 N분(예: 2분) 안에 이미 카카오 알림을 보냈다면</li>
            <li>또 보내지 않고 로그만 기록</li>
          </ul>
        </li>
      </ul>
      <p>예시 규칙:</p>
      <ul>
        <li>DANGER 이상 : 카메라별 최소 2분 쿨타임</li>
        <li>WARNING : 카메라별 최소 5분 쿨타임</li>
      </ul>
      <p>
        이 쿨타임 정보는 DB에 <code>last_notified_at</code> 같은 필드로 관리하거나
        별도 <code>event_notification</code> 테이블에서 관리할 수 있습니다.
      </p>
    </div>

    <div class="section">
      <h2>템플릿 구조 설계</h2>

      <h3>템플릿 예시</h3>
<pre>[화재 감지 알림]

위험도: {level}
장소: {camera_name} ({group_name})
시간: {time}

내용: {message}

※ CCTV 화면을 즉시 확인해 주세요.
</pre>

      <p>
        실제 저장은 <code>message_format</code> TEXT 필드에 그대로 들어가고,<br />
        <code>{변수명}</code> 형태로 Placeholder를 작성합니다.
      </p>

      <h3>지원할 변수 목록(예시)</h3>
      <table>
        <tr><th>변수 이름</th><th>의미</th></tr>
        <tr><td><code>{level}</code></td><td>이벤트 레벨 (WARNING / DANGER / CRITICAL 등)</td></tr>
        <tr><td><code>{camera_name}</code></td><td>카메라 이름</td></tr>
        <tr><td><code>{group_name}</code></td><td>카메라 그룹/층 이름</td></tr>
        <tr><td><code>{time}</code></td><td>감지 시각 (예: 2025-12-11 10:33)</td></tr>
        <tr><td><code>{message}</code></td><td>이벤트 요약 메시지</td></tr>
        <tr><td><code>{event_id}</code></td><td>이벤트 ID (상세 조회 링크 등에 활용 가능)</td></tr>
      </table>

      <p><strong>템플릿 파싱 로직 절차</strong></p>
      <ol>
        <li>이벤트 + 카메라 정보 조회</li>
        <li><code>variables</code> 딕셔너리 구성  
          (예: <code>{"level": "DANGER", "camera_name": "1층 로비-1번", ...}</code>)</li>
        <li><code>message_format</code> 문자열에서 <code>{key}</code> 를 실제 값으로 치환</li>
      </ol>
    </div>

    <div class="section">
      <h2>알림 발송 흐름(백엔드 로직)</h2>

      <h3>전체 플로우 요약</h3>
      <ol>
        <li>AI → BE: <code>POST /api/events</code>로 이벤트 생성</li>
        <li>BE: DB에 <code>event</code>, <code>event_box</code> 저장</li>
        <li>BE: 이벤트 레벨 &amp; 카메라 설정 확인</li>
        <li>조건 충족 시 → 카카오 알림 발송 로직 실행</li>
        <li>발송 성공/실패 기록 (로그 또는 <code>event_notification</code> 테이블)</li>
      </ol>

      <h3>의사 코드(로직 느낌)</h3>
<pre>def handle_new_event(event_id: int):
    event = load_event(event_id)
    camera = load_camera(event.camera_id)

    # 1) 알림 대상 레벨인지 체크
    if event.level not in ["WARNING", "DANGER", "CRITICAL"]:
        return

    # 2) 카메라별 쿨타임 체크
    if not can_notify(event, camera):
        return

    # 3) 템플릿 선택 (기본 템플릿 또는 레벨별 템플릿)
    template = load_template("default_fire_alert")

    # 4) 변수 맵 구성
    variables = {
        "level": event.level,
        "camera_name": camera.name,
        "group_name": camera.group_name,
        "time": event.detected_at.strftime("%Y-%m-%d %H:%M"),
        "message": event.message or "",
        "event_id": str(event.id),
    }

    # 5) 메시지 생성
    message_text = render_template(template.message_format, variables)

    # 6) 수신자(관리자) 목록 조회
    receivers = load_alert_receivers()   # user 테이블 or 설정 테이블

    # 7) 카카오 API 호출
    for user in receivers:
        send_kakao_message(
            phone_number=user.phone_number,
            text=message_text
        )

    # 8) 발송 로그 저장
    save_notification_log(event, receivers)
</pre>
      <p>
        여기서 <code>send_kakao_message()</code> 부분은 실제 카카오 비즈메시지(알림톡/친구톡) API나,
        중간에 붙일 별도 알림 서버에 맞게 구현합니다.
      </p>
    </div>

    <div class="section">
      <h2>수신자 관리 방식</h2>

      <h3>간단한 버전</h3>
      <ul>
        <li><code>user</code> 테이블에 <code>phone_number</code>가 있는 사용자 중</li>
        <li><code>role</code>이 ADMIN / MANAGER 인 계정만 알림 발송</li>
        <li>또는 별도 <code>alert_enabled</code> 플래그를 두어 알림 수신 여부를 제어</li>
      </ul>

      <h3>확장 버전(선택)</h3>
      <ul>
        <li><code>alert_target</code> 같은 테이블을 만들어:
          <ul>
            <li>알림 그룹(예: “야간 근무자”, “주간 근무자”)</li>
            <li>레벨별 수신자 설정 (DANGER 이상만 받는 사람 등)</li>
          </ul>
        </li>
      </ul>
      <p>
        프로젝트 범위를 생각하면, 1차 버전은 <strong>“관리자 전원에게 발송”</strong> 구조가 가장 단순하고 구현이 쉽습니다.
      </p>
    </div>

    <div class="section">
      <h2>카카오 연동용 테스트 API (개발 편의용)</h2>
      <p>
        실제 운영과는 별개로, 개발 단계에서 연동 테스트를 쉽게 하기 위해
        다음과 같은 테스트 API를 둘 수 있습니다.
      </p>
      <ul>
        <li><code>POST /api/notify/test-kakao</code>
          <ul>
            <li>특정 번호로 임의 메시지 전송</li>
            <li>카카오 API 연동 성공 여부 확인용</li>
          </ul>
        </li>
      </ul>
    </div>

    <div class="section">
      <h2>예시 시나리오</h2>

      <h3>시나리오 1 – 1층 로비에서 DANGER 발생</h3>
      <ol>
        <li>1층 로비-1번 카메라에서 불꽃 감지 → <code>DANGER</code> 이벤트 생성</li>
        <li>BE, 이벤트 저장 후:
          <ul>
            <li>최근 2분 동안 이 카메라에서 DANGER 알림 보낸 기록 없음 → 알림 허용</li>
          </ul>
        </li>
        <li>템플릿 + 변수로 메시지 생성:</li>
      </ol>

<pre>[화재 감지 알림]

위험도: DANGER
장소: 1층 로비-1번 (1층 로비)
시간: 2025-12-11 10:33

내용: 1층 로비 화염 강도 증가

※ CCTV 화면을 즉시 확인해 주세요.
</pre>

      <ol start="4">
        <li>관리자 3명에게 카카오 발송</li>
        <li>발송 결과를 <code>event_notification</code> 또는 로그 테이블에 저장</li>
      </ol>
    </div>

    <div class="section">
      <h2>카카오 연동 시 필요한 외부 정보 정리</h2>
      <p>
        실제 카카오톡 알림을 보내려면, 카카오 또는 비즈메시지 대행사 쪽에서
        아래와 같은 값들을 미리 발급받아 시스템에 설정해 두어야 합니다.
      </p>

      <h3>1) 카카오 디벨로퍼스(Kakao Developers) 관련 정보</h3>
      <ul>
        <li>카카오 개발자 콘솔에서 생성한 앱:
          <ul>
            <li>앱 이름</li>
            <li>앱 ID</li>
            <li>REST API 키</li>
            <li>(필요 시) Admin 키</li>
          </ul>
        </li>
        <li>카카오 로그인이나 기타 플랫폼 기능을 함께 쓸 경우:
          <ul>
            <li>Redirect URI (로그인/인가에 사용하는 콜백 URL)</li>
          </ul>
        </li>
      </ul>

      <h3>2) 카카오톡 채널(플러스친구) / 비즈메시지 관련 정보</h3>
      <ul>
        <li>카카오톡 채널(플러스친구) 정보
          <ul>
            <li>채널 이름</li>
            <li>채널 ID (예: <code>@mycompany_fire</code> 형태)</li>
          </ul>
        </li>
        <li>알림톡/친구톡 발신용 프로필 정보
          <ul>
            <li>발신프로필 키(발신 프로필 ID)</li>
            <li>발신 번호(콜백 번호)</li>
          </ul>
        </li>
        <li>알림 템플릿 관련 정보
          <ul>
            <li>템플릿 코드 / 템플릿 ID</li>
            <li>템플릿 이름 (예: <code>default_fire_alert</code>)</li>
            <li>템플릿 검수 상태 (승인 여부)</li>
            <li>템플릿에 사용 가능한 변수 목록 (플랫폼에 등록된 변수명)</li>
          </ul>
        </li>
      </ul>

      <h3>3) 비즈메시지 대행사(또는 카카오 비즈 API) 제공 정보</h3>
      <ul>
        <li>API 호출용 기본 URL (Base URL)</li>
        <li>인증용 키/토큰
          <ul>
            <li>API Key / Client ID / Client Secret 등</li>
            <li>요청 시 사용하는 Authorization 헤더 형식</li>
          </ul>
        </li>
        <li>요청·응답 형식 문서 (필드명, 응답 코드 규칙 등)</li>
        <li>(필요 시) 발신 프로필과 템플릿이 연결된 “계정 ID / 고객사 코드” 등</li>
      </ul>

      <h3>4) 우리 시스템 설정 파일(.env 등)에 넣어둘 값 예시</h3>
<pre># 카카오 / 비즈메시지 연동용 예시 환경변수
KAKAO_APP_KEY=...
KAKAO_ADMIN_KEY=...
KAKAO_CHANNEL_ID=@mycompany_fire
KAKAO_SENDER_KEY=...
KAKAO_TEMPLATE_CODE_FIRE=default_fire_alert
KAKAO_API_BASE_URL=https://api.xxx.bizmsg.co.kr
KAKAO_CALLBACK_NUMBER=021234567
</pre>
      <p>
        실제 프로젝트에서는 강의나 과제 요구사항에 따라,
        위 값들 중 일부는 “실제 키” 대신 “가짜 값 + Mock 서버”로 대체해서 시연할 수도 있습니다.
      </p>
    </div>

  </div>
</body>
</html>
