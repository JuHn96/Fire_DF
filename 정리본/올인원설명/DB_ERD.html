<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>DB 테이블 구조 & ERD 개념 정리</title>
  <style>
    /* --------------------------------
       전체 레이아웃 & 배경
    --------------------------------- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.7;
      margin: 0;
      padding: 32px 16px;
      background: #e5e7eb;
      color: #111827;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 28px 32px 32px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      border: 1px solid #e5e7eb;
    }

    /* --------------------------------
       제목 스타일
    --------------------------------- */
    h1, h2, h3 {
      margin-top: 0;
      color: #111827;
    }

    h1 {
      font-size: 30px;
      font-weight: 800;
      margin: 0 0 14px 0;
      letter-spacing: -0.03em;
      line-height: 1.3;
    }

    h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    h3 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 14px;
      margin-bottom: 8px;
    }

    .page-header {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 14px;
      margin-bottom: 20px;
    }

    /* --------------------------------
       섹션 카드 + 바이올렛 바
    --------------------------------- */
    .section {
      position: relative;
      background: linear-gradient(to right, #ffffff, #fafafa);
      padding: 18px 22px 18px 28px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
    }

    .section::before {
      content: "";
      position: absolute;
      left: 10px;
      top: 18px;
      bottom: 18px;
      width: 4px;
      border-radius: 999px;
      background: linear-gradient(
        to bottom,
        #ede9fe,
        #c4b5fd,
        #818cf8
      );
    }

    /* --------------------------------
       리스트
    --------------------------------- */
    ul {
      margin-top: 6px;
      padding-left: 20px;
    }

    li {
      margin-bottom: 6px;
      font-size: 14px;
    }

    /* --------------------------------
       테이블 스타일
    --------------------------------- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      margin-bottom: 18px;
      font-size: 14px;
    }

    table th,
    table td {
      border: 1px solid #d1d5db;
      padding: 8px 10px;
    }

    table th {
      background: #eef2ff;
      color: #111827;
      font-weight: 600;
      text-align: left;
    }

    table tr:nth-child(even) td {
      background: #f9fafb;
    }

    /* --------------------------------
       코드 / 쿼리 (어두운 배경)
    --------------------------------- */
    pre {
      background: #020617;
      color: #e5e7eb;
      padding: 14px 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 12px;
      margin-bottom: 14px;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      border: 1px solid #111827;
    }

    code {
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      background-color: #f3f4ff;
      padding: 2px 5px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
    }

    /* --------------------------------
       반응형
    --------------------------------- */
    @media (max-width: 640px) {
      .page {
        padding: 20px 16px 22px;
        border-radius: 12px;
      }
      h1 {
        font-size: 24px;
      }
      h2 {
        font-size: 19px;
      }
    }
  </style>
</head>

<body>
  <div class="page">

    <header class="page-header">
      <h1>DB 테이블 구조 & ERD 개념 정리</h1>
    </header>

    <div class="section">
      <h2>설계 목표</h2>
      <p>이 데이터베이스는 다음 핵심 기능을 안정적으로 처리하도록 설계한다.</p>
      <ul>
        <li>CCTV 장비 및 그룹 정보 관리</li>
        <li>AI 화재 감지 이벤트 저장</li>
        <li>객체 박스 및 이미지 데이터 저장</li>
        <li>사용자 및 알림 템플릿 관리</li>
        <li>확장성과 정규화(2NF) 중심으로 구성</li>
      </ul>
    </div>

    <div class="section">
      <h2>ERD 핵심 개념</h2>

      <p>이 시스템의 주요 엔티티들은 다음과 같다.</p>

      <ul>
        <li><strong>cctv_group</strong> – CCTV 그룹 정보</li>
        <li><strong>cctv</strong> – 카메라 장비</li>
        <li><strong>event</strong> – 화재 감지 기록</li>
        <li><strong>event_box</strong> – 감지된 객체 박스</li>
        <li><strong>event_image</strong> – 이벤트 이미지(원본/박스버전 등)</li>
        <li><strong>user</strong> – 관리자/관제 인력</li>
        <li><strong>kakao_template</strong> – 카카오 알림 템플릿</li>
      </ul>

      <h3>엔티티 관계</h3>

      <ul>
        <li>cctv_group <strong>(1) – (N)</strong> cctv</li>
        <li>cctv <strong>(1) – (N)</strong> event</li>
        <li>event <strong>(1) – (N)</strong> event_box</li>
        <li>event <strong>(1) – (N)</strong> event_image</li>
      </ul>

      <p><em>전체 흐름: cctv_group → cctv → event → (event_box, event_image)</em></p>
    </div>

    <div class="section">
      <h2>테이블 상세 정의</h2>

      <h3>CCTV 그룹 (cctv_group)</h3>
      <table>
        <tr><th>컬럼명</th><th>타입</th><th>설명</th></tr>
        <tr><td>id</td><td>BIGINT PK</td><td>그룹 ID</td></tr>
        <tr><td>name</td><td>VARCHAR(100)</td><td>그룹명</td></tr>
        <tr><td>description</td><td>VARCHAR(255)</td><td>설명</td></tr>
        <tr><td>sort_order</td><td>INT</td><td>정렬 순서</td></tr>
        <tr><td>created_at</td><td>DATETIME</td><td>생성 시각</td></tr>
        <tr><td>updated_at</td><td>DATETIME</td><td>수정 시각</td></tr>
      </table>

      <h3>CCTV 정보 (cctv)</h3>
      <table>
        <tr><th>컬럼명</th><th>타입</th><th>설명</th></tr>
        <tr><td>id</td><td>BIGINT PK</td><td>CCTV 고유 ID</td></tr>
        <tr><td>group_id</td><td>BIGINT FK</td><td>cctv_group.id</td></tr>
        <tr><td>name</td><td>VARCHAR(100)</td><td>카메라 이름</td></tr>
        <tr><td>rtsp_url</td><td>VARCHAR(255)</td><td>RTSP 주소</td></tr>
        <tr><td>location</td><td>VARCHAR(255)</td><td>설치 위치 설명</td></tr>
        <tr><td>is_main</td><td>TINYINT(1)</td><td>메인 대시보드 표시 여부</td></tr>
        <tr><td>status</td><td>VARCHAR(20)</td><td>ONLINE / OFFLINE</td></tr>
        <tr><td>created_at</td><td>DATETIME</td><td>생성 시각</td></tr>
        <tr><td>updated_at</td><td>DATETIME</td><td>수정 시각</td></tr>
      </table>

      <h3>이벤트(event)</h3>
      <table>
        <tr><th>컬럼명</th><th>타입</th><th>설명</th></tr>
        <tr><td>id</td><td>BIGINT PK</td><td>이벤트 ID</td></tr>
        <tr><td>camera_id</td><td>BIGINT FK</td><td>cctv.id</td></tr>
        <tr><td>level</td><td>VARCHAR(20)</td><td>INFO / WARNING / DANGER / CRITICAL</td></tr>
        <tr><td>detected_at</td><td>DATETIME</td><td>감지 시간</td></tr>
        <tr><td>message</td><td>VARCHAR(255)</td><td>요약 메시지</td></tr>
        <tr><td>image_path</td><td>VARCHAR(255)</td><td>대표 이미지 저장 경로</td></tr>
        <tr><td>raw_payload</td><td>JSON</td><td>AI 원본 정보</td></tr>
        <tr><td>created_at</td><td>DATETIME</td><td>DB 저장 시각</td></tr>
      </table>

      <h3>이벤트 박스(event_box)</h3>
      <table>
        <tr><th>컬럼명</th><th>타입</th><th>설명</th></tr>
        <tr><td>id</td><td>BIGINT PK</td><td>박스 ID</td></tr>
        <tr><td>event_id</td><td>BIGINT FK</td><td>event.id</td></tr>
        <tr><td>x1</td><td>INT</td><td>좌상단 X</td></tr>
        <tr><td>y1</td><td>INT</td><td>좌상단 Y</td></tr>
        <tr><td>x2</td><td>INT</td><td>우하단 X</td></tr>
        <tr><td>y2</td><td>INT</td><td>우하단 Y</td></tr>
        <tr><td>score</td><td>FLOAT</td><td>신뢰도</td></tr>
        <tr><td>label</td><td>VARCHAR(50)</td><td>fire / smoke 등</td></tr>
      </table>

      <h3>이벤트 이미지(event_image)</h3>
      <table>
        <tr><th>컬럼명</th><th>타입</th><th>설명</th></tr>
        <tr><td>id</td><td>BIGINT PK</td><td>이미지 ID</td></tr>
        <tr><td>event_id</td><td>BIGINT FK</td><td>event.id</td></tr>
        <tr><td>image_type</td><td>VARCHAR(30)</td><td>RAW / BOXED / THUMB</td></tr>
        <tr><td>image_path</td><td>VARCHAR(255)</td><td>파일 경로</td></tr>
        <tr><td>created_at</td><td>DATETIME</td><td>생성 시간</td></tr>
      </table>

      <h3>사용자(user)</h3>
      <table>
        <tr><th>컬럼명</th><th>타입</th><th>설명</th></tr>
        <tr><td>id</td><td>BIGINT PK</td><td>유저 ID</td></tr>
        <tr><td>username</td><td>VARCHAR(50)</td><td>로그인 ID</td></tr>
        <tr><td>password_hash</td><td>VARCHAR(255)</td><td>암호화된 PW</td></tr>
        <tr><td>name</td><td>VARCHAR(100)</td><td>이름</td></tr>
        <tr><td>role</td><td>VARCHAR(20)</td><td>ADMIN / VIEWER</td></tr>
        <tr><td>phone_number</td><td>VARCHAR(20)</td><td>카카오 알림용 번호</td></tr>
        <tr><td>created_at</td><td>DATETIME</td><td></td></tr>
        <tr><td>updated_at</td><td>DATETIME</td><td></td></tr>
      </table>

      <h3>카카오 알림 템플릿(kakao_template)</h3>
      <table>
        <tr><th>컬럼명</th><th>타입</th><th>설명</th></tr>
        <tr><td>id</td><td>BIGINT PK</td><td></td></tr>
        <tr><td>template_name</td><td>VARCHAR(50)</td><td>템플릿 이름</td></tr>
        <tr><td>message_format</td><td>TEXT</td><td>메시지 포맷</td></tr>
        <tr><td>active</td><td>TINYINT(1)</td><td>사용 여부</td></tr>
        <tr><td>created_at</td><td>DATETIME</td><td></td></tr>
        <tr><td>updated_at</td><td>DATETIME</td><td></td></tr>
      </table>
    </div>

    <div class="section">
      <h2>정규화 및 인덱스 전략</h2>
      <p>각 테이블은 단일 기본키 기반으로 구성되어 있어 2NF 구조를 만족한다.</p>
      <p>조회가 많은 event 테이블은 다음 인덱스를 가질 것을 권장한다.</p>

      <pre>
INDEX idx_event_camera (camera_id);
INDEX idx_event_level (level);
INDEX idx_event_datetime (detected_at);
      </pre>
    </div>

    <div class="section">
      <h2>샘플 쿼리</h2>

      <h3>최근 24시간 위험 이벤트 조회</h3>
      <pre>
SELECT e.id, e.detected_at, e.level, c.name AS camera_name
FROM event e
JOIN cctv c ON e.camera_id = c.id
WHERE e.detected_at >= NOW() - INTERVAL 1 DAY
  AND e.level IN ('DANGER','CRITICAL')
ORDER BY e.detected_at DESC;
      </pre>

      <h3>카메라별 이벤트 집계</h3>
      <pre>
SELECT c.name AS camera_name, COUNT(*) AS event_count
FROM event e
JOIN cctv c ON e.camera_id = c.id
WHERE e.detected_at >= DATE_FORMAT(CURRENT_DATE,'%Y-%m-01')
GROUP BY c.id;
      </pre>

    </div>

  </div>
</body>
</html>
