<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>시스템 흐름도 설명</title>
  <style>
    /* --------------------------------
       전체 레이아웃 & 배경 (2-C 템플릿)
    --------------------------------- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      line-height: 1.7;
      margin: 0;
      padding: 32px 16px;
      background: #e5e7eb;
      color: #111827;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      padding: 28px 32px 32px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      border: 1px solid #e5e7eb;
    }

    /* --------------------------------
       제목 스타일
    --------------------------------- */
    h1, h2, h3 {
      margin-top: 0;
      color: #111827;
    }

    h1 {
      font-size: 30px;
      font-weight: 800;
      margin: 0 0 14px 0;
      letter-spacing: -0.03em;
      line-height: 1.3;
    }

    h2 {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    h3 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 14px;
      margin-bottom: 8px;
    }

    .page-header {
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 14px;
      margin-bottom: 20px;
    }

    /* --------------------------------
       섹션 카드 + 바이올렛 바
    --------------------------------- */
    .section {
      position: relative;
      background: linear-gradient(to right, #ffffff, #fafafa);
      padding: 16px 20px 18px 28px;
      border-radius: 12px;
      margin-bottom: 22px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
    }

    .section::before {
      content: "";
      position: absolute;
      left: 10px;
      top: 16px;
      bottom: 16px;
      width: 4px;
      border-radius: 999px;
      background: linear-gradient(
        to bottom,
        #ede9fe,
        #c4b5fd,
        #818cf8
      );
    }

    /* --------------------------------
       리스트 / 인라인 코드 / 인용구
    --------------------------------- */
    ul {
      margin-top: 6px;
      padding-left: 20px;
    }

    li {
      margin-bottom: 6px;
      font-size: 14px;
    }

    ol {
      padding-left: 20px;
      margin-top: 6px;
    }

    code {
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      background-color: #f3f4ff;
      padding: 2px 5px;
      border-radius: 4px;
      border: 1px solid #e5e7eb;
    }

    blockquote {
      margin: 10px 0 10px 0;
      padding: 10px 12px;
      border-left: 4px solid #c4b5fd;
      background: #f5f3ff;
      border-radius: 6px;
    }

    blockquote p {
      margin: 0;
    }

    /* --------------------------------
       반응형
    --------------------------------- */
    @media (max-width: 640px) {
      .page {
        padding: 20px 16px 22px;
        border-radius: 12px;
      }
      h1 {
        font-size: 24px;
      }
      h2 {
        font-size: 19px;
      }
    }
  </style>
</head>
<body>
  <div class="page">

    <header class="page-header">
      <h1>시스템 흐름도 설명 (Flowchart용 텍스트)</h1>
    </header>

    <div class="section">
      <h2>1. 상위 단계 한 줄짜리 버전</h2>
      <p>플로우차트에서 제일 위에 들어갈 큰 흐름은 이거 하나로 정리된다:</p>
      <blockquote>
        <p><strong>CCTV → AI 화재 감지 → 백엔드 이벤트 처리 → DB 저장 → WebSocket 알림 → 대시보드 표시 → 카카오 알림 발송 → 이벤트 종료/해제</strong></p>
      </blockquote>
      <p>이걸 기준으로 아래에 세부 단계들을 쪼개서 쓰면 된다.</p>
    </div>

    <div class="section">
      <h2>2. 풀 버전 단계 흐름 (정상 시나리오 기준)</h2>
      <p>플로우차트 그릴 때, <strong>왼쪽 위에서 오른쪽/아래로 흐르는 구조</strong> 기준으로 단계 정리:</p>

      <ol>
        <li>
          <strong>시작 (Start)</strong><br />
          “시스템 기동 / 관제 시작” 정도로 둬도 됨
        </li>
        <li>
          <strong>CCTV 실시간 스트림 제공</strong><br />
          기존 NVR/CCTV에서 RTSP 스트림 송출<br />
          예: <code>rtsp://...</code>
        </li>
        <li>
          <strong>AI 서버에서 RTSP 연결</strong><br />
          ai-server가 각 카메라 RTSP에 접속<br />
          특정 간격으로 프레임 캡처
        </li>
        <li>
          <strong>AI 화재 감지 모델 추론</strong><br />
          각 프레임에 대해 화재 여부 판단<br />
          결과: “화재 없음” or “화재 감지 후보”
        </li>
        <li>
          <strong>조건 확인 (판단 분기)</strong><br />
          조건:
          <ul>
            <li>신뢰도(confidence) ≥ 기준치</li>
            <li>일정 시간 이상 연속 감지</li>
          </ul>
          플로우차트에서 <strong>다이아몬드(조건)</strong> 도형 사용
        </li>
        <li>
          <strong>[아니오] 조건 미달 → 일반 모니터링 계속</strong><br />
          “False → 다시 4번(모델 추론)으로 루프”<br />
          그냥 평상시 모니터링 상태 유지
        </li>
        <li>
          <strong>[예] 화재 감지 이벤트 생성 (AI)</strong><br />
          “화재 감지됨”으로 판단<br />
          캡처 이미지 저장<br />
          camera_id, event_time, confidence, image_path 등 정리
        </li>
        <li>
          <strong>AI → 백엔드로 화재 이벤트 전송</strong><br />
          <code>POST /internal/events/fire</code><br />
          Body에 카메라, 시간, 신뢰도, 이미지 경로 등 포함
        </li>
        <li>
          <strong>백엔드에서 기존 이벤트 조회</strong><br />
          같은 카메라에 진행 중인 ACTIVE 이벤트 있는지 확인<br />
          최근 n분 내 중복 여부 체크
        </li>
        <li>
          <strong>조건 분기: 신규 이벤트? 기존 이벤트 갱신?</strong><br />
          다이아몬드 도형<br />
          예/아니오 두 갈래
        </li>
        <li>
          <strong>[예] 신규 화재 이벤트 생성</strong><br />
          DB에 새로운 이벤트 레코드 INSERT<br />
          상태: ACTIVE<br />
          초기 단계(level 1 또는 2) 설정
        </li>
        <li>
          <strong>[아니오] 기존 이벤트 갱신</strong><br />
          감지 시간, 신뢰도, 단계(level) 업데이트<br />
          필요 시 level 1 → 2 → 3 등 에스컬레이션
        </li>
        <li>
          <strong>단계(level)에 따른 처리 로직</strong><br />
          <ul>
            <li>Level 1: 시스템 내부 알림만 (옵션)</li>
            <li>Level 2: 대시보드 + 카카오 1차 발송</li>
            <li>Level 3: 긴급 알림, 추가 카카오 발송 가능</li>
          </ul>
          이 부분은 플로우차트에서 <strong>조건(레벨)</strong> 기준으로 분기시켜도 되고,<br />
          하나의 “단계 결정 및 처리” 블록으로 뭉쳐도 됨
        </li>
        <li>
          <strong>DB에 이벤트 최종 저장 / 업데이트</strong><br />
          이벤트 로그 테이블에 INSERT/UPDATE<br />
          이미지 경로, 레벨, 상태, 카카오 발송 여부 등 반영
        </li>
        <li>
          <strong>WebSocket으로 프론트엔드에 실시간 알림 푸시</strong><br />
          메시지 내용: 카메라, 단계, 상태, 메시지 텍스트 등<br />
          type: <code>fire_event</code>, action: <code>created</code> or <code>updated</code>
        </li>
        <li>
          <strong>프론트엔드 대시보드 UI 업데이트</strong><br />
          해당 CCTV 카드 색상 변경(예: 빨강)<br />
          상단 알림 배너/팝업 표시<br />
          로그 탭에 새 이벤트 한 줄 추가
        </li>
        <li>
          <strong>조건 분기: 카카오 발송 필요?</strong><br />
          단계(level), 설정에 따라 분기<br />
          예/아니오 다이아몬드 도형
        </li>
        <li>
          <strong>[예] 카카오 알림 발송</strong><br />
          템플릿 + 데이터 바인딩<br />
          카카오(또는 대행 API)에 요청<br />
          DB에 발송 이력 기록
        </li>
        <li>
          <strong>[아니오] 내부 알림만 유지</strong><br />
          카카오 발송 없이 관제 화면에서만 처리
        </li>
        <li>
          <strong>사용자(관리자)가 알림 확인</strong><br />
          대시보드 화면에서 상태 확인<br />
          카카오톡 알림도 받음
        </li>
        <li>
          <strong>조건 분기: 이벤트 종료(화재 해제)?</strong><br />
          <ul>
            <li>AI 감지 결과가 일정 시간 동안 “화재 없음”이면 → 해제 조건 충족</li>
            <li>또는 관리자가 수동으로 종료/오탐 처리 선택</li>
          </ul>
        </li>
        <li>
          <strong>[예] 이벤트 종료 처리</strong><br />
          AI → BE에 “해제 이벤트” 전달<br />
          <code>POST /internal/events/fire/clear</code><br />
          백엔드에서 해당 이벤트 <code>status = RESOLVED</code><br />
          <code>resolved_at</code> 기록
        </li>
        <li>
          <strong>프론트엔드 해제 알림 갱신</strong><br />
          카드 색상 정상(초록)으로 복귀<br />
          로그에서 “해결됨” 표시
        </li>
        <li>
          <strong>[선택] 오탐 처리 플로우</strong><br />
          관리자가 이벤트 상세에서 “오탐 처리” 버튼 클릭<br />
          DB status = CANCELED, cancel_reason 저장<br />
          통계에서 오탐으로 별도 분류 가능
        </li>
        <li>
          <strong>종료 (End)</strong><br />
          해당 이벤트에 대한 실시간 알림 플로우 종료<br />
          시스템 자체는 계속 모니터링 루프로 남아있음<br />
          실제 플로우차트에서는 “이벤트 처리 종료”로 끝내면 됨
        </li>
      </ol>
    </div>

    <div class="section">
      <h2>3. 플로우차트 도형 추천 매핑</h2>
      <p>그림 그릴 때 어떤 도형 쓸지 같이 정리:</p>
      <ul>
        <li><strong>타원</strong>
          <ul>
            <li>Start / End</li>
            <li>“시스템 기동”, “이벤트 처리 종료”</li>
          </ul>
        </li>
        <li><strong>직사각형(프로세스)</strong>
          <ul>
            <li>CCTV 스트림 송출</li>
            <li>AI 모델 추론</li>
            <li>백엔드 이벤트 생성/갱신</li>
            <li>DB 저장</li>
            <li>WebSocket 전송</li>
            <li>대시보드 UI 업데이트</li>
            <li>카카오 발송</li>
          </ul>
        </li>
        <li><strong>마름모(조건/분기)</strong>
          <ul>
            <li>화재 조건 충족 여부</li>
            <li>신규 이벤트 여부</li>
            <li>카카오 발송 필요 여부</li>
            <li>이벤트 종료 여부(해제/오탐)</li>
          </ul>
        </li>
        <li><strong>평행사변형(입출력, 선택사항)</strong>
          <ul>
            <li>“AI → BE 이벤트 전달”</li>
            <li>“BE → 카카오 발송 요청” 같은 I/O 표현에 사용 가능</li>
          </ul>
        </li>
      </ul>
    </div>

    <div class="section">
      <h2>4. 요약용 한 줄 버전 (작은 그림용)</h2>
      <p>만약 PPT에 <strong>간단 버전 플로우차트</strong>를 넣는다면, 아래 정도로 줄여서 쓸 수 있다:</p>
      <ol>
        <li>CCTV RTSP 송출</li>
        <li>AI 화재 감지</li>
        <li>BE 이벤트 저장·단계 판단</li>
        <li>WebSocket 실시간 알림</li>
        <li>대시보드 표시</li>
        <li>카카오 알림 발송</li>
        <li>해제/오탐 처리 후 종료</li>
      </ol>
    </div>

  </div>
</body>
</html>
